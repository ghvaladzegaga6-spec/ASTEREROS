<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASTER EROS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        #gui { position: absolute; top: 15px; left: 15px; width: 260px; background: rgba(0, 0, 0, 0.9); border: 1px solid #ffcc00; border-radius: 8px; z-index: 100; color: white; overflow: hidden; transition: 0.3s; }
        #gui.collapsed { height: 40px; }
        .gui-header { padding: 10px 15px; background: #ffcc00; color: #000; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; }
        .gui-content { padding: 15px; }
        
        /* ფილტრის სტილი */
        .filter-container { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-btn { flex: 1; padding: 8px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 11px; transition: 0.2s; }
        .filter-btn.active { background: #ffcc00; color: #000; border-color: #ffcc00; }

        .info-p { margin-top: 10px; text-align: center; border-top: 1px solid #333; padding-top: 10px; display: none; }
        .st-free { color: #00ff88; font-size: 11px; font-weight: bold; }
        .st-sold { color: #ff4444; font-size: 11px; font-weight: bold; }
        .st-pending { color: #ffa500; font-size: 11px; font-weight: bold; }
        .buy-btn { width: 100%; padding: 12px; background: #ffcc00; color: #000; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; }
        .terms-btn { background: transparent; color: #aaa; border: 1px solid #444; padding: 5px; font-size: 10px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 4px; }
        #secret-area { margin-top: 10px; display: none; background: #222; padding: 10px; border-radius: 4px; }
        #secret-msg { color: #ffcc00; font-style: italic; margin-top: 5px; word-wrap: break-word; }
        
        #modal, #terms-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; border: 1px solid #ffcc00; padding: 20px; z-index: 1000; width: 320px; color: white; max-height: 85vh; overflow-y: auto; border-radius: 8px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }
        
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; color: #aaa; margin-bottom: 4px; }
        input, textarea { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        .important-note { color: #ff4444; font-weight: bold; font-size: 12px; margin-bottom: 10px; line-height: 1.4; border: 1px dashed #ff4444; padding: 8px; border-radius: 4px; }
        .bank-details { background: #222; padding: 10px; border-radius: 4px; font-size: 11px; margin-bottom: 15px; border-left: 3px solid #ffcc00; line-height: 1.6; }
        .bank-details span { color: #ffcc00; display: block; margin-bottom: 5px; }
        .terms-text { font-size: 11px; line-height: 1.5; color: #ccc; text-align: justify; }
        .delivery-note { font-size: 9px; color: #ffcc00; margin-top: 2px; display: block; }
    </style>
</head>
<body>

<div id="gui">
    <div class="gui-header" onclick="document.getElementById('gui').classList.toggle('collapsed')">
        <span>ASTER EROS</span>
        <span id="arr">▼</span>
    </div>
    <div class="gui-content">
        <div class="filter-container">
            <button class="filter-btn active" id="filterAll" onclick="setFilter('all')">ყველა</button>
            <button class="filter-btn" id="filterFree" onclick="setFilter('free')">თავისუფალი</button>
        </div>

        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="number" id="sId" placeholder="შეიყვანეთ ID">
            <button onclick="searchStar()" style="cursor:pointer; background:#444; color:#fff; border:none; padding:0 10px; border-radius:4px;">ძებნა</button>
        </div>
        <div id="info-p" class="info-p">
            <div id="statusTxt"></div>
            <div id="idTxt" style="font-size: 18px; margin: 5px 0;"></div>
            <div id="secret-area">
                <input type="text" id="unlockCode" placeholder="6-ციფრიანი კოდი" maxlength="6">
                <button onclick="checkCode()" style="margin-top:5px; width:100%; background:#444; color:#fff; border:none; padding:5px; cursor:pointer;">ნახვა</button>
                <div id="secret-msg"></div>
            </div>
            <button class="buy-btn" id="bBtn"></button>
        </div>
        <button class="terms-btn" onclick="openTerms()">პირობები და დაბრუნების პოლიტიკა</button>
    </div>
</div>

<div class="overlay" id="ovl" onclick="closeM()"></div>

<div id="modal">
    <div class="important-note">
        თანხის გადმორიცხვისას, დანიშნულებაში აუცილებლად მიუთითეთ მხოლოდ ვარსკვლავის ID, რომელიც შეიძინეთ
    </div>
    <div class="bank-details">
        <span>რეკვიზიტები:</span>
        BOG-GE15BG0000000602634574 გ.ღ<br>
        TBC-GE85TB7244845061100111 გ.ღ
    </div>
    <div class="form-group">
        <label>ვარსკვლავის სახელი (რომელიც გსურთ დაარქვათ)</label>
        <input type="text" id="starName" placeholder="მაგ: მარიამი">
    </div>
    <div class="form-group">
        <label>შეტყობინება (ვისაც უძღვნით)</label>
        <textarea id="uMsg" rows="2" placeholder="დაწერეთ ტექსტი..."></textarea>
    </div>
    <div class="form-group">
        <label>პირადი ნომერი</label>
        <input type="text" id="uPersonalId" placeholder="11 ციფრიანი ნომერი">
    </div>
    <div class="form-group">
        <label>ტელეფონის ნომერი</label>
        <input type="text" id="uPh" placeholder="5xx xx xx xx">
    </div>
    <div class="form-group">
        <label>ელ-ფოსტა</label>
        <input type="email" id="uMail">
    </div>
    <div class="form-group">
        <label>მისამართი</label>
        <input type="text" id="uAddr">
        <span class="delivery-note">ნივთის მიწოდების საფასურის გადახდა ხდება კურიერთან.</span>
    </div>
    <div class="form-group">
        <label>დოკუმენტის ნომერი (ტრანზაქციის დეტალებიდან)</label>
        <input type="text" id="uDocNum" placeholder="მაგ: 123456789">
        <p style="font-size:10px; color:#ffcc00; margin-top:5px;">* თიბისი ბანკის შემთხვევაში მიუთითეთ დოკუმენტის ნომერი.</p>
    </div>
    <button class="buy-btn" onclick="submitOrder()">დადასტურება</button>
</div>

<div id="terms-modal">
    <h3 style="color:#ffcc00; margin-top:0;">პირობები</h3>
    <div class="terms-text">
        ვებსაიტის მეშვეობით მომხმარებელს ეძლევა შესაძლებლობა შეიძინოს ციფრულ სამყაროში არსებული უნიკალური ვარსკვლავი, რომელიც წარმოადგენს ციფრულ აქტივს. შეძენის დასრულებისთანავე, ვარსკვლავზე საკუთრებისა და სარგებლობის უფლება სრულად გადადის მომხმარებელზე. ვინაიდან ეს არის ექსკლუზიური პროდუქტი, გაყიდვის შემდეგ მისი ხელახლა შეძენა ან სხვა პირზე გადაცემა ჩვენი პლატფორმის მეშვეობით აღარ ხდება. 
        <br><br>
        ვარსკვლავის შეძენასთან ერთად მომხმარებელი იღებს ფიზიკურ სამაჯურს, რომელზეც დატანილია ინდივიდუალური იდენტიფიკაციის კოდი. ეს კოდი თქვენი გასაღებია — ის უკავშირდება კონკრეტულ ციფრულ ვარსკვლავს და იძლევა საშუალებას, გახსნათ და წაიკითხოთ შეძენის პერიოდში დატოვებული შეტყობინება. გთხოვთ, კოდი შეინახოთ უსაფრთხოდ, რადგან მისი დაკარგვის ან სხვა პირისთვის გადაცემის შემთხვევისას, საიტის ადმინისტრაცია პასუხისმგებლობას ვერ აიღებს თქვენს პირად შეტყობინებებზე ან წვდომაზე. 
        <br><br>
        დაბრუნების პოლიტიკა ეყრდნობა მომხმარებელთა უფლებების დაცვის მოქმედ კანონმდებლობას. თუმცა, პროდუქტის სპეციფიკიდან გამომდინარე — რადგან თქვენ მომენტალურად იღებთ წვდომას ციფრულ კონტენტზე და გეგზავნებათ თქვენთვის ინდივიდუალურად მომზადებული სამაჯური — შეძენის განხორციელებით თქვენ ადასტურებთ, რომ უარს ამბობთ ნივთის ყოველგვარი მიზეზის გარეშე დაბრუნების უფლებაზე. 
        <br><br>
        თანხის დაბრუნება შესაძლებელია მხოლოდ იმ შემთხვევაში, თუ შეძენისას დაფიქსირდა ტექნიკური ხარვეზი და თქვენ ფაქტობრივად ვერ მიიღეთ ის მომსახურება, რომელსაც პლატფორმა გპირდებოდათ. ასეთ დროს ჩვენ ვიღებთ ვალდებულებას, უმოკლეს ვადაში გამოვასწოროთ პრობლემა, ხოლო თუ ეს შეუძლებელი აღმოჩნდება, სრულად დაგიბრუნებთ გადახდილ თანხას იმავე მეთოდით, რომლითაც ისარგებლეთ ყიდვისას. 
        <br><br>
        თუ შეძენა წარმატებით დასრულდა და თქვენ მიიღეთ წვდომა ციფრულ აქტივზე, თანხის უკან დაბრუნება აღარ მოხდება. მომხმარებელი აცნობიერებს და ეთანხმება იმას, რომ ციფრული პლატფორმის ბუნებიდან გამომდინარე, საიტის მფლობელი პასუხს არ აგებს მომავალში პლატფორმის ფუნქციონირების შესაძლო შეწყვეტაზე. საიტის მუშაობის ნებისმიერი მიზეზით შეწყვეტა, გაუქმება ან მიუწვდომლობა არ წარმოადგენს გადახდილი თანხის დაბრუნების საფუძველს, რადგან შეძენილი ციფრული აქტივის გადაცემა მომხმარებლისთვის უკვე დასრულებულ ფაქტად ითვლება. 
        <br><br>
        ვებსაიტის გამოყენებითა და ყიდვის განხორციელებით თქვენ ადასტურებთ, რომ გაეცანით ამ პირობებს, ეთანხმებით მათ და სრულად გაცნობიერებული გაქვთ პროდუქტის თავისებურება.
    </div>
    <button class="buy-btn" onclick="closeM()">გასაგებია</button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAYlCwpzE7-D-Jx1sWb1Qq4MKup7akm4g4",
        authDomain: "aster-eros.firebaseapp.com",
        databaseURL: "https://aster-eros-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "aster-eros",
        storageBucket: "aster-eros.appspot.com",
        appId: "1:172323770559:web:046051111b98acc239b60a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 10, 100000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enableZoom = true;
    controls.enablePan = true;
    controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

    camera.position.set(0, 15000, 25000);

    const bgGroup = new THREE.Group();
    const bgGeo = new THREE.BufferGeometry();
    const bgPos = [];
    for(let i=0; i<25000; i++) bgPos.push((Math.random()-0.5)*80000, (Math.random()-0.5)*80000, (Math.random()-0.5)*80000);
    bgGeo.setAttribute('position', new THREE.Float32BufferAttribute(bgPos, 3));
    const bgPoints = new THREE.Points(bgGeo, new THREE.PointsMaterial({color: 0xffffff, size: 4}));
    bgGroup.add(bgPoints);
    scene.add(bgGroup);

    const starGroup = new THREE.Group();
    scene.add(starGroup);
    const stars = [];
    let currentFilter = 'all';

    function createGlowTexture(color, isPink = false) {
        const canvas = document.createElement('canvas');
        canvas.width = 128; canvas.height = 128;
        const ctx = canvas.getContext('2d');
        const gradient = ctx.createRadialGradient(64, 64, 0, 64, 64, 64);
        if(isPink) { gradient.addColorStop(0, 'rgba(255, 230, 240, 1)'); gradient.addColorStop(0.3, 'rgba(255, 105, 180, 0.8)'); gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); }
        else { gradient.addColorStop(0, 'rgba(255, 255, 255, 1)'); gradient.addColorStop(0.4, color); gradient.addColorStop(1, 'rgba(0, 0, 0, 0)'); }
        ctx.fillStyle = gradient; ctx.fillRect(0, 0, 128, 128);
        return new THREE.CanvasTexture(canvas);
    }

    function createStar(id, x, y, z, size, color, isPink = false) {
        const mat = new THREE.SpriteMaterial({ map: createGlowTexture(color, isPink), transparent: true, blending: THREE.AdditiveBlending });
        const sprite = new THREE.Sprite(mat);
        sprite.position.set(x, y, z);
        let fSize = (id === 1) ? 2400 : (isPink ? 1440 : size * 6);
        sprite.scale.set(fSize, fSize, 1);
        sprite.userData = { id, baseScale: fSize, sold: false, pending: false, price: (id === 1 ? 149 : 79), message: "", code: "", starName: "" };
        starGroup.add(sprite);
        stars.push(sprite);
    }

    createStar(1, 0, 0, 500, 400, '#ffcc00');
    const starColors = ['#ffcc00', '#00d2ff', '#bd00ff', '#ff4e50', '#8a2be2'];
    for(let i=2; i<=350; i++) {
        const angle = 0.15 * (i-1);
        const radius = 4000 + ((i-1)*50);
        createStar(i, radius * Math.cos(angle), (Math.random()-0.5)*4000, radius * Math.sin(angle), 50 + Math.random()*40, starColors[i % 5]);
    }
    createStar(351, 15000, 8000, -15000, 120, '#ff1493', true);

    db.ref('stars_data').on('value', snap => {
        const data = snap.val() || {};
        stars.forEach(s => {
            if(data[s.userData.id]) {
                const info = data[s.userData.id];
                s.userData.sold = String(info.sold) === 'true';
                s.userData.pending = String(info.pending) === 'true';
                s.userData.message = info.message || "";
                s.userData.code = String(info.code || ""); 
                s.userData.starName = info.starName || "";
            }
        });
        applyFilter(); // მონაცემების განახლებისას ფილტრის ხელახლა გადატარება
    });

    // ფილტრის ფუნქციონალი
    window.setFilter = (type) => {
        currentFilter = type;
        document.getElementById('filterAll').classList.toggle('active', type === 'all');
        document.getElementById('filterFree').classList.toggle('active', type === 'free');
        applyFilter();
    };

    function applyFilter() {
        stars.forEach(s => {
            if (currentFilter === 'free') {
                // თუ ფილტრია "თავისუფალი", ვმალავთ მათ ვინც გაყიდულია ან დამუშავებაშია
                s.visible = !(s.userData.sold || s.userData.pending);
            } else {
                s.visible = true;
            }
        });
    }

    let activeS = null, lastClickTime = 0;

    function select(s) {
        if(!s.visible) return; // თუ ვარსკვლავი დამალულია ფილტრით, ვერ ავირჩევთ
        if(activeS) activeS.scale.set(activeS.userData.baseScale, activeS.userData.baseScale, 1);
        activeS = s;
        s.scale.set(s.userData.baseScale * 2, s.userData.baseScale * 2, 1);
        gsap.to(controls.target, { x: s.position.x, y: s.position.y, z: s.position.z, duration: 1 });
        gsap.to(camera.position, { x: s.position.x + 2000, y: s.position.y + 1000, z: s.position.z + 2000, duration: 1 });
        document.getElementById('info-p').style.display = 'block';
        
        let displayText = `ვარსკვლავი #${s.userData.id}`;
        if(s.userData.sold && s.userData.starName) {
            displayText += ` - "${s.userData.starName}"`;
        }
        document.getElementById('idTxt').innerText = displayText;
        
        const st = document.getElementById('statusTxt'), btn = document.getElementById('bBtn'), secretArea = document.getElementById('secret-area');
        document.getElementById('secret-msg').innerText = "";
        
        if(s.userData.sold) {
            st.innerText = "გაყიდულია"; st.className = "st-sold";
            btn.style.display = 'none'; secretArea.style.display = 'block';
        } else if(s.userData.pending) {
            st.innerText = "დამუშავების პროცესშია..."; st.className = "st-pending";
            btn.style.display = 'none'; secretArea.style.display = 'none';
        } else {
            st.innerText = "თავისუფალია"; st.className = "st-free";
            btn.style.display = 'block'; btn.innerText = `ყიდვა - ${s.userData.price} GEL`;
            secretArea.style.display = 'none';
        }
    }

    function resetView() {
        gsap.to(camera.position, { x: 0, y: 15000, z: 25000, duration: 1.5 });
        gsap.to(controls.target, { x: 0, y: 0, z: 0, duration: 1.5 });
        if(activeS) activeS.scale.set(activeS.userData.baseScale, activeS.userData.baseScale, 1);
        activeS = null; document.getElementById('info-p').style.display = 'none';
    }

    function checkCode() {
        const inputVal = document.getElementById('unlockCode').value.trim();
        if(inputVal !== "" && inputVal === activeS.userData.code) {
            document.getElementById('secret-msg').innerText = activeS.userData.message;
        } else { alert("არასწორი კოდი!"); }
    }

    function submitOrder() {
        const ph = document.getElementById('uPh').value, doc = document.getElementById('uDocNum').value;
        const sName = document.getElementById('starName').value;
        const pId = document.getElementById('uPersonalId').value;

        if(!ph || !doc || !sName || !pId) return alert("შეავსეთ ყველა სავალდებულო ველი!");

        db.ref('stars_data/' + activeS.userData.id).set({
            pending: true, 
            sold: false, 
            starName: sName,
            personalId: pId,
            message: document.getElementById('uMsg').value,
            customerPhone: ph, 
            customerMail: document.getElementById('uMail').value,
            address: document.getElementById('uAddr').value, 
            docNumber: doc, 
            timestamp: Date.now()
        }).then(() => { alert("მოთხოვნა გაიგზავნა!"); closeM(); });
    }

    window.addEventListener('pointerup', e => {
        if(e.target.closest('#gui, #modal, #terms-modal')) return;
        const m = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
        const ray = new THREE.Raycaster();
        ray.setFromCamera(m, camera);
        const hit = ray.intersectObjects(stars.filter(s => s.visible));
        const now = Date.now(), isDoubleClick = (now - lastClickTime < 350);
        lastClickTime = now;
        if(hit.length > 0) {
            const clicked = hit[0].object;
            if(isDoubleClick && activeS && activeS.userData.id === clicked.userData.id) resetView();
            else select(clicked);
        }
    });

    window.searchStar = () => {
        const s = stars.find(x => x.userData.id == document.getElementById('sId').value);
        if(s) {
            if (currentFilter === 'free' && (s.userData.sold || s.userData.pending)) {
                alert("ეს ვარსკვლავი გაყიდულია. სანახავად გადართეთ ფილტრი 'ყველა'-ზე.");
            } else {
                select(s);
            }
        }
    }

    document.getElementById('bBtn').onclick = () => { document.getElementById('modal').style.display='block'; document.getElementById('ovl').style.display='block'; }
    window.openTerms = () => { document.getElementById('terms-modal').style.display='block'; document.getElementById('ovl').style.display='block'; }
    window.closeM = () => { document.getElementById('modal').style.display='none'; document.getElementById('terms-modal').style.display='none'; document.getElementById('ovl').style.display='none'; }

    function animate() {
        requestAnimationFrame(animate);
        bgGroup.rotation.y += 0.0003; bgGroup.rotation.x += 0.0001;
        controls.update(); renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>
