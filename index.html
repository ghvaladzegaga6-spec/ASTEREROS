<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASTER EROS - Live Galaxy</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #gui {
            position: absolute; top: 15px; left: 15px; width: 220px;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px);
            border: 0.5px solid rgba(255, 204, 0, 0.5); padding: 12px;
            border-radius: 10px; z-index: 100; color: white; transition: 0.3s;
        }
        @media (max-width: 600px) {
            #gui { width: 80%; left: 10%; top: 10px; }
            #modal { width: 90% !important; }
        }
        #gui.minimized { width: 50px; height: 20px; overflow: hidden; opacity: 0.5; }
        h2 { margin: 0 0 10px 0; font-size: 13px; color: #ffcc00; letter-spacing: 2px; text-align: center; }
        input, textarea {
            width: 100%; background: rgba(255,255,255,0.1); border: 0.5px solid #444;
            color: white; padding: 10px; margin-bottom: 8px; border-radius: 4px;
            box-sizing: border-box; outline: none; font-size: 14px;
        }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; cursor: pointer;
               font-weight: bold; font-size: 11px; text-transform: uppercase; margin-bottom: 5px; }
        .btn-buy { background: #ffcc00; color: #000; }
        .btn-pay { background: #00ff88; color: #000; }
        .btn-back { background: #444; color: #fff; }
        .btn-search { background: #222; color: #aaa; border: 0.5px solid #444; }
        .status { font-size: 12px; font-weight: bold; margin-bottom: 8px; }
        .free { color: #00ff88; }
        .sold { color: #ff4d4d; }
        #modal { display: none; position: fixed; top: 50%; left: 50%;
                 transform: translate(-50%, -50%); background: #0d0d0d; border: 1px solid #ffcc00; 
                 padding: 20px; border-radius: 12px; z-index: 1000; width: 280px; color: white; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                   background: rgba(0,0,0,0.85); z-index: 999; }
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:#000; 
                  display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10001; color:#ffcc00; }
    </style>
</head>
<body>

<div id="loader">
    <h1>ASTER EROS</h1>
    <p>უკავშირდება გალაქტიკას...</p>
</div>

<div id="gui">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2 id="logo">ASTER EROS</h2>
        <span id="toggle" style="cursor:pointer; font-size:18px;">[-]</span>
    </div>
    <div id="content">
        <input type="number" id="searchId" placeholder="შეიყვანე ID">
        <button class="btn btn-search" id="searchBtn">ძებნა</button>
        <div id="info-box"><p style="font-size:10px; color:#666; text-align:center;">აირჩიეთ ვარსკვლავი</p></div>
    </div>
</div>

<div class="overlay" id="overlay"></div>
<div id="modal">
    <h3 style="color:#ffcc00; margin-top:0;">შესყიდვა - 30 GEL</h3>
    <textarea id="uMsg" rows="2" placeholder="სამუდამო წერილი..."></textarea>
    <input type="text" id="uCode" maxlength="8" placeholder="8-ნიშნა საიდუმლო კოდი">
    <input type="text" id="cardNumber" placeholder="ბარათის ნომერი" maxlength="16">
    <button class="btn btn-pay" id="payBtn">გადახდა</button>
    <button class="btn btn-back" id="backBtn">უკან</button>
</div>

<script type="importmap">
    { 
        "imports": { 
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js", 
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
        } 
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { initializeApp } from "firebase/app";
    import { getDatabase, ref, set, onValue } from "firebase/database";

    const firebaseConfig = {
        apiKey: "AIzaSyAYlCwpzE7-D-Jx1sWb1Qq4MKup7akm4g4",
        authDomain: "aster-eros.firebaseapp.com",
        databaseURL: "https://aster-eros-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "aster-eros",
        storageBucket: "aster-eros.firebasestorage.app",
        messagingSenderId: "172323770559",
        appId: "1:172323770559:web:046051111b98acc239b60a",
        measurementId: "G-RG7Y6QXTQ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const starNames = ["Luma", "Aera", "Solin", "Nira", "Vela", "Orin", "Elyx", "Nova", "Sora", "Kora", "Lior", "Aris", "Zela", "Oryn", "Lyra", "Aven", "Hales", "Nexa", "Iora", "Vale", "Selo", "Mirae", "Arix", "Lune", "Virox", "Elen", "Sian", "Oro", "Nexo", "Kiro", "Lysa", "Aelo", "Zeno", "Oria", "Lumo", "Serae", "Vian", "Ilen", "Narae", "Haloa", "Soly", "Avena", "Lioris", "Nexor", "Velae", "Oron", "Zirae", "Elio", "Kalen", "Suna", "Liora", "Arixa", "Novae", "Isera", "Vireo", "Olen", "Syra", "Nolin", "Haloe", "Zorin", "Lumae", "Aerae", "Solis", "Neris", "Velor", "Orionyx", "Elyra", "Noxa", "Sore", "Korae", "Liro", "Arion", "Zelo", "Orel", "Lyron", "Avenor", "Halor", "Nexis", "Iorin", "Valen", "Selor", "Miron", "Arisx", "Lunea", "Virox", "Elor", "Sinae", "Orox", "Nexel"];

    const scene = new THREE.Scene();
    // FAR PLANE გაიზარდა 5000-დან 15000-მდე, რომ ვარსკვლავები არ გაქრეს დაშორებისას
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 15000); 
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; 
    controls.autoRotate = true;
    controls.autoRotateSpeed = 0.15;
    camera.position.set(0, 500, 1500);

    const starGeo = new THREE.BufferGeometry();
    const starPos = [];
    for(let i=0; i<15000; i++) starPos.push((Math.random()-0.5)*8000, (Math.random()-0.5)*8000, (Math.random()-0.5)*8000);
    starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
    const starField = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 1.2}));
    scene.add(starField);

    const stars = [];
    let globalRegistry = {};

    function createPremiumStar(id) {
        const rad = 8 + Math.random() * 6;
        const geo = new THREE.SphereGeometry(rad, 24, 24);
        const mat = new THREE.MeshStandardMaterial({ color: 0xffcc00, emissive: 0xffcc00, emissiveIntensity: 1.5 });
        const m = new THREE.Mesh(geo, mat);
        m.position.set((Math.random()-0.5)*3000, (Math.random()-0.5)*3000, (Math.random()-0.5)*3000);
        m.userData = { id, name: starNames[id-1] || "Star "+id };
        scene.add(m);
        stars.push(m);
    }
    for(let i=1; i<=200; i++) createPremiumStar(i);

    onValue(ref(db, 'purchased_stars'), (snap) => {
        globalRegistry = snap.val() || {};
        stars.forEach(s => s.material.emissiveIntensity = globalRegistry[s.userData.id] ? 0.3 : 1.5);
        document.getElementById('loader').style.display = 'none';
    });

    function showDetails(star) {
        const id = star.userData.id;
        const data = globalRegistry[id];
        const box = document.getElementById('info-box');
        controls.autoRotate = false;
        
        if(!data) {
            box.innerHTML = `<div class="status">ID: #${id} <br> <span class="free">თავისუფალია</span></div><button class="btn btn-buy" id="openPay">ყიდვა</button>`;
            document.getElementById('openPay').onclick = () => { document.getElementById('modal').style.display='block'; document.getElementById('overlay').style.display='block'; };
        } else {
            box.innerHTML = `<div class="status">ID: #${id} <br> <span class="sold">გაყიდულია</span></div><input type="password" id="cInput" placeholder="კოდი"><button class="btn btn-buy" id="viewBtn">ნახვა</button><div id="secret-res" style="display:none; color:#ffcc00; margin-top:5px;"></div>`;
            document.getElementById('viewBtn').onclick = () => {
                if(document.getElementById('cInput').value === data.code) {
                    const res = document.getElementById('secret-res');
                    res.style.display = 'block'; res.innerText = data.msg;
                } else alert("არასწორია!");
            };
        }

        gsap.to(controls.target, { x: star.position.x, y: star.position.y, z: star.position.z, duration: 1.2 });
        gsap.to(camera.position, { x: star.position.x + 150, y: star.position.y + 50, z: star.position.z + 150, duration: 1.2 });
    }

    // მობილურისთვის შეხების დამუშავება
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    function onSelect(event) {
        if(event.target.closest('#gui') || event.target.closest('#modal')) return;
        
        const x = event.touches ? event.touches[0].clientX : event.clientX;
        const y = event.touches ? event.touches[0].clientY : event.clientY;
        
        mouse.x = (x / window.innerWidth) * 2 - 1;
        mouse.y = -(y / window.innerHeight) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        const hits = raycaster.intersectObjects(stars);
        if(hits.length > 0) showDetails(hits[0].object);
    }

    window.addEventListener('touchend', onSelect);
    window.addEventListener('click', onSelect);

    document.getElementById('payBtn').onclick = () => {
        const msg = document.getElementById('uMsg').value;
        const code = document.getElementById('uCode').value;
        if(msg && code.length === 8) {
            set(ref(db, 'purchased_stars/' + stars.find(s => s.material.emissiveIntensity > 1).userData.id), { msg, code, timestamp: Date.now() });
            document.getElementById('modal').style.display='none';
            document.getElementById('overlay').style.display='none';
        } else alert("შეავსეთ სწორად!");
    };

    document.getElementById('backBtn').onclick = () => { document.getElementById('modal').style.display='none'; document.getElementById('overlay').style.display='none'; };
    document.getElementById('toggle').onclick = () => document.getElementById('gui').classList.toggle('minimized');

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }
    animate();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</body>
</html>
